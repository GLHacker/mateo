<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juego: Recolector de Estrellas</title>
    <link rel="stylesheet" href="../style.css">
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            overflow: hidden;
            margin: 0;
        }
        #game-container {
            width: 100vw;
            height: 100vh;
        }
        .controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 10;
        }
        .score {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 2rem;
            color: #333;
        }
    </style>
</head>
<body>
    <div id="game-container"></div>
    <div class="score" id="score">Estrellas: 0 / 10</div>
    <div class="controls">
        <a href="index.html" class="menu-button">Volver a Juegos</a>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('game-container');
            let scene, camera, renderer, player, stars = [];
            let score = 0;
            const numStars = 10;
            const keys = {};

            function init() {
                // Scene and Camera
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x87ceeb); // Sky blue
                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.set(0, 15, 20);
                camera.lookAt(0, 0, 0);

                // Renderer
                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                container.appendChild(renderer.domElement);

                // Lights
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                scene.add(ambientLight);
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(10, 20, 15);
                scene.add(directionalLight);

                // Ground
                const groundGeometry = new THREE.PlaneGeometry(50, 50);
                const groundMaterial = new THREE.MeshStandardMaterial({ color: 0x228b22 }); // Forest green
                const ground = new THREE.Mesh(groundGeometry, groundMaterial);
                ground.rotation.x = -Math.PI / 2;
                scene.add(ground);

                // Player (Mateo)
                const playerGeometry = new THREE.CapsuleGeometry(1, 1, 4, 8);
                const playerMaterial = new THREE.MeshStandardMaterial({ color: 0xff4500 }); // OrangeRed
                player = new THREE.Mesh(playerGeometry, playerMaterial);
                player.position.y = 1.5;
                scene.add(player);

                // Stars
                createStars();

                // Event Listeners
                document.addEventListener('keydown', (e) => keys[e.code] = true);
                document.addEventListener('keyup', (e) => keys[e.code] = false);
                window.addEventListener('resize', onWindowResize);

                animate();
            }

            function createStars() {
                const starShape = new THREE.Shape();
                starShape.moveTo(0, 1);
                starShape.lineTo(0.2, 0.2);
                starShape.lineTo(1, 0.2);
                starShape.lineTo(0.4, -0.2);
                starShape.lineTo(0.6, -1);
                starShape.lineTo(0, -0.5);
                starShape.lineTo(-0.6, -1);
                starShape.lineTo(-0.4, -0.2);
                starShape.lineTo(-1, 0.2);
                starShape.lineTo(-0.2, 0.2);
                starShape.lineTo(0, 1);

                const extrudeSettings = { depth: 0.2, bevelEnabled: false };
                const starGeometry = new THREE.ExtrudeGeometry(starShape, extrudeSettings);
                const starMaterial = new THREE.MeshStandardMaterial({ color: 0xffff00 });

                for (let i = 0; i < numStars; i++) {
                    const star = new THREE.Mesh(starGeometry, starMaterial);
                    star.position.set(
                        (Math.random() - 0.5) * 45,
                        1,
                        (Math.random() - 0.5) * 45
                    );
                    star.rotation.x = Math.PI / 2;
                    stars.push(star);
                    scene.add(star);
                }
            }

            function updatePlayerPosition() {
                const speed = 0.2;
                if (keys['ArrowUp'] || keys['KeyW']) player.position.z -= speed;
                if (keys['ArrowDown'] || keys['KeyS']) player.position.z += speed;
                if (keys['ArrowLeft'] || keys['KeyA']) player.position.x -= speed;
                if (keys['ArrowRight'] || keys['KeyD']) player.position.x += speed;

                // Simple boundary check
                player.position.x = Math.max(-24, Math.min(24, player.position.x));
                player.position.z = Math.max(-24, Math.min(24, player.position.z));
            }

            function checkCollisions() {
                const playerBox = new THREE.Box3().setFromObject(player);
                for (let i = stars.length - 1; i >= 0; i--) {
                    const star = stars[i];
                    const starBox = new THREE.Box3().setFromObject(star);
                    if (playerBox.intersectsBox(starBox)) {
                        scene.remove(star);
                        stars.splice(i, 1);
                        score++;
                        document.getElementById('score').innerText = `Estrellas: ${score} / ${numStars}`;
                        checkWin();
                    }
                }
            }

            function checkWin() {
                if (score === numStars) {
                    setTimeout(() => {
                        alert("Â¡Felicidades, has recogido todas las estrellas!");
                    }, 100);
                }
            }

            function onWindowResize() {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }

            function animate() {
                requestAnimationFrame(animate);
                updatePlayerPosition();
                checkCollisions();

                stars.forEach(star => {
                    star.rotation.z += 0.02;
                });

                renderer.render(scene, camera);
            }

            init();
        });
    </script>
</body>
</html>